---
import { bestMatch } from "@udia/mime-parser";
import { languageTags } from "../i18n/languages";
import BaseLayout from "../layouts/BaseLayout.astro";

const acceptLanguage = Astro.request.headers.get("accept-language");
let language = "en";
if (acceptLanguage) {
  language = bestMatch(languageTags, acceptLanguage) || "en";
}

const { path } = Astro.params;
const langPath = `/${language}/${path}`;
const pages = await Astro.glob("./**/*");
const urls = pages.map((page) => page.url);

let redirectTo = null;
if (urls.includes(langPath)) {
  redirectTo = langPath;
}

const status = Astro.response.status;
Astro.response.status = status && status !== 200 ? status : 404;
const statusText =
  Astro.response.statusText && Astro.response.statusText !== "OK"
    ? Astro.response.statusText
    : status === 404
    ? "Not Found"
    : "Error";
Astro.response.statusText = statusText;
---

{
  redirectTo ? (
    <meta http-equiv="refresh" content={`0;url=${redirectTo}${Astro.url.search}`} />
  ) : null
}
<BaseLayout title={statusText}>
  <h1>{statusText}</h1>
</BaseLayout>
